@using CampusEats.Client.Models
@using CampusEats.Client.Services
@using CampusEats.Client.Components
@inject CategoryService CategoryService

@if (isVisible)
{
    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in" @onclick="CloseModal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col animate-scale-in" @onclick:stopPropagation="true">
            <div class="bg-gradient-to-r from-oxford-blue to-oxford-blue-dark px-6 py-5 flex justify-between items-center border-b-4 border-tan/30">
                <h2 class="text-2xl font-bold text-white">
                    Manage Categories
                </h2>
                <button class="text-white/80 hover:text-white hover:bg-white/10 transition-all text-2xl leading-none w-9 h-9 rounded-lg flex items-center justify-center" @onclick="CloseModal">x</button>
            </div>

            <div class="p-6 overflow-y-auto flex-1 bg-gray-50/30">
                @if (errorMessage != null)
                {
                    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl mb-5 shadow-sm">
                        <span class="font-medium">@errorMessage</span>
                    </div>
                }

                @if (successMessage != null)
                {
                    <div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-xl mb-5 animate-fade-in shadow-sm">
                        <span class="font-medium">@successMessage</span>
                    </div>
                }

                <!-- Add New Category Form -->
                <div class="bg-white border border-oxford-blue/20 rounded-xl p-6 mb-6 shadow-sm">
                    <h3 class="font-bold text-gray-900 mb-4 text-lg">
                        Add New Category
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                            <input type="text"
                                   class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg focus:border-oxford-blue focus:outline-none focus:ring-2 focus:ring-oxford-blue/20 transition-all shadow-sm"
                                   @bind="newCategoryName"
                                   placeholder="Category name" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Icon</label>
                            <IconPicker @bind-Value="newCategoryIcon" />
                        </div>
                        <div class="flex items-end">
                            <button type="button" class="w-full bg-gradient-to-r from-oxford-blue to-oxford-blue-dark text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                    @onclick="AddCategory"
                                    disabled="@isSaving">
                                @if (isSaving)
                                {
                                    <span class="flex items-center justify-center gap-2">
                                        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>Adding...</span>
                                    </span>
                                }
                                else
                                {
                                    <span>Add Category</span>
                                }
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Existing Categories List with Drag & Drop -->
                <div>
                    <h3 class="font-bold text-gray-900 mb-4 text-lg">
                        Existing Categories
                        <span class="text-sm font-normal text-gray-500 ml-2">(Drag to reorder)</span>
                    </h3>
                    @if (isLoading)
                    {
                        <div class="text-center py-12 bg-white rounded-xl border border-gray-200">
                            <svg class="animate-spin h-12 w-12 mx-auto mb-3 text-oxford-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="text-gray-600 font-medium">Loading categories...</p>
                        </div>
                    }
                    else if (!categories.Any())
                    {
                        <div class="text-center py-12 bg-white rounded-xl border-2 border-dashed border-gray-300">
                            <p class="text-gray-500 text-xl font-semibold mb-2">No categories yet</p>
                            <p class="text-gray-400 text-sm">Add one above to get started!</p>
                        </div>
                    }
                    else
                    {
                        <DragDropList TItem="CategoryResponse" @bind-Items="categories" OnOrderChanged="SaveCategoryOrder">
                            <ItemTemplate Context="category">
                                @if (editingCategoryId == category.CategoryId)
                                {
                                    <!-- Edit Mode -->
                                    <div class="flex items-center gap-3 w-full">
                                        <input type="text"
                                               class="flex-1 px-3 py-2 bg-white border border-oxford-blue rounded-lg focus:outline-none focus:ring-2 focus:ring-oxford-blue/20 shadow-sm"
                                               @bind="editName"
                                               placeholder="Category name" />
                                        <div class="w-48">
                                            <IconPicker @bind-Value="editIcon" />
                                        </div>
                                        <button type="button" class="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-all shadow-sm"
                                                @onclick="() => SaveEdit(category.CategoryId)">
                                            Save
                                        </button>
                                        <button type="button" class="px-4 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition-all shadow-sm"
                                                @onclick="CancelEdit">
                                            Cancel
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <!-- View Mode -->
                                    <div class="flex items-center gap-3 w-full">
                                        <span class="w-8 h-8 flex items-center justify-center text-oxford-blue">
                                            <LucideIcon Name="@category.Icon" Class="w-6 h-6" />
                                        </span>
                                        <span class="flex-1 font-semibold text-gray-900">
                                            @category.Name
                                        </span>
                                        <div class="flex gap-2">
                                            <button type="button" class="px-3 py-1.5 bg-oxford-blue text-white rounded-lg font-medium hover:bg-oxford-blue-dark transition-all text-sm shadow-sm"
                                                    @onclick="() => StartEdit(category)"
                                                    @onclick:stopPropagation="true">
                                                Edit
                                            </button>
                                            <button type="button" class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition-all text-sm shadow-sm"
                                                    @onclick="() => DeleteCategory(category)"
                                                    @onclick:stopPropagation="true">
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                }
                            </ItemTemplate>
                        </DragDropList>
                    }
                </div>
            </div>

            <div class="border-t border-gray-200 px-6 py-4 bg-gray-50 flex justify-end">
                <button class="px-8 py-2.5 bg-gradient-to-r from-oxford-blue to-oxford-blue-dark text-white rounded-lg font-semibold hover:shadow-lg hover:-translate-y-0.5 transition-all"
                        @onclick="CloseModal">
                    Done
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public EventCallback OnChanged { get; set; }

    private bool isVisible = false;
    private bool isLoading = false;
    private bool isSaving = false;
    private string? errorMessage;
    private string? successMessage;

    private List<CategoryResponse> categories = new();

    // Add new category
    private string newCategoryName = "";
    private string newCategoryIcon = "";

    // Edit category
    private Guid? editingCategoryId = null;
    private string editName = "";
    private string editIcon = "";

    public async Task OpenAsync()
    {
        isVisible = true;
        errorMessage = null;
        successMessage = null;
        await LoadCategories();
    }

    private void CloseModal()
    {
        isVisible = false;
        StateHasChanged();
    }

    private async Task LoadCategories()
    {
        try
        {
            isLoading = true;
            var loaded = await CategoryService.GetCategoriesAsync() ?? new List<CategoryResponse>();
            categories = loaded.OrderBy(c => c.SortOrder).ThenBy(c => c.Name).ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load categories: {ex.Message}";
            categories = new List<CategoryResponse>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task AddCategory()
    {
        try
        {
            isSaving = true;
            errorMessage = null;
            successMessage = null;

            if (string.IsNullOrWhiteSpace(newCategoryName))
            {
                errorMessage = "Category name is required";
                return;
            }

            if (string.IsNullOrWhiteSpace(newCategoryIcon))
            {
                errorMessage = "Please select an icon";
                return;
            }

            // Set sort order to be at the end
            var maxSortOrder = categories.Any() ? categories.Max(c => c.SortOrder) : 0;

            var request = new CreateCategoryRequest(
                newCategoryName.Trim(),
                newCategoryIcon.Trim(),
                maxSortOrder + 1
            );

            await CategoryService.CreateCategoryAsync(request);

            // Clear form
            newCategoryName = "";
            newCategoryIcon = "";

            successMessage = "Category added successfully";
            await LoadCategories();
            await OnChanged.InvokeAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to add category: {ex.Message}";
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private void StartEdit(CategoryResponse category)
    {
        editingCategoryId = category.CategoryId;
        editName = category.Name;
        editIcon = category.Icon;
    }

    private void CancelEdit()
    {
        editingCategoryId = null;
        editName = "";
        editIcon = "";
    }

    private async Task SaveEdit(Guid categoryId)
    {
        try
        {
            errorMessage = null;
            successMessage = null;

            if (string.IsNullOrWhiteSpace(editName))
            {
                errorMessage = "Category name is required";
                return;
            }

            var existingCategory = categories.FirstOrDefault(c => c.CategoryId == categoryId);
            var sortOrder = existingCategory?.SortOrder ?? 0;

            var request = new UpdateCategoryRequest(
                editName.Trim(),
                editIcon.Trim(),
                sortOrder
            );

            await CategoryService.UpdateCategoryAsync(categoryId, request);

            successMessage = "Category updated successfully";
            CancelEdit();
            await LoadCategories();
            await OnChanged.InvokeAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to update category: {ex.Message}";
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task SaveCategoryOrder()
    {
        try
        {
            errorMessage = null;
            var orderedIds = categories.Select(c => c.CategoryId).ToList();
            await CategoryService.ReorderCategoriesAsync(orderedIds);
            successMessage = "Category order saved";
            await OnChanged.InvokeAsync();
            StateHasChanged();

            // Clear success message after 2 seconds
            await Task.Delay(2000);
            if (successMessage == "Category order saved")
            {
                successMessage = null;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to save order: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task DeleteCategory(CategoryResponse category)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete '{category.Name}'?"))
            return;

        try
        {
            errorMessage = null;
            successMessage = null;

            await CategoryService.DeleteCategoryAsync(category.CategoryId);

            successMessage = "Category deleted successfully";
            await LoadCategories();
            await OnChanged.InvokeAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to delete category: {ex.Message}";
        }
        finally
        {
            StateHasChanged();
        }
    }

    [Inject] private IJSRuntime JSRuntime { get; set; } = default!;
}