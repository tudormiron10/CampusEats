@page "/checkout"
@using CampusEats.Client.Services
@using CampusEats.Client.Models
@using Microsoft.JSInterop
@inject CartService CartService
@inject PaymentService PaymentService
@inject LoyaltyService LoyaltyService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IAsyncDisposable

<PageTitle>Checkout - CampusEats</PageTitle>

<div class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold text-oxford-blue mb-8">Checkout</h1>

    @if (isLoading)
    {
        <div class="flex flex-col items-center justify-center py-16">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-oxford-blue mb-4"></div>
            <p class="text-gray-600 text-lg">@loadingMessage</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="bg-red-50 border-2 border-red-200 text-red-700 px-6 py-4 rounded-lg mb-6">
            <h3 class="font-bold mb-2">Error</h3>
            <p>@errorMessage</p>
            <button class="mt-4 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors"
                    @onclick="RetryCheckout">
                Try Again
            </button>
        </div>
    }
    else if (paymentSucceeded)
    {
        <div class="bg-gradient-to-br from-green-50 to-emerald-100 border-2 border-green-300 rounded-2xl p-10 text-center shadow-lg">
            <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-green-400 to-emerald-500 rounded-full flex items-center justify-center shadow-lg shadow-green-200">
                <i class="bi bi-check-lg text-white text-4xl"></i>
            </div>
            <h2 class="text-3xl font-bold text-green-800 mb-3">Payment Successful!</h2>
            <p class="text-green-700 mb-8 text-lg">Your order has been placed and is being prepared.</p>
            <a href="/orders" class="inline-block bg-gradient-to-r from-oxford-blue to-blue-900 text-white px-8 py-4 rounded-xl font-semibold text-lg hover:-translate-y-1 hover:shadow-xl hover:shadow-oxford-blue/30 transition-all duration-300">
                <i class="bi bi-bag-check mr-2"></i>View My Orders
            </a>
        </div>
    }
    else
    {
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Order Summary -->
            <div class="bg-white rounded-lg shadow-md border border-tan-light p-6">
                <h2 class="text-2xl font-bold text-oxford-blue mb-4">Order Summary</h2>
                
                <div class="space-y-3 mb-6">
                    @foreach (var item in CartService.Items)
                    {
                        <div class="flex justify-between items-center py-2 border-b border-tan-light">
                            <div>
                                <span class="font-medium text-oxford-blue">@item.Name</span>
                                <span class="text-gray-500 text-sm ml-2">x@item.Quantity</span>
                                @if (item.IsRedeemed)
                                {
                                    <span class="ml-2 text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded-full">FREE</span>
                                }
                            </div>
                            <span class="font-semibold text-oxford-blue">
                                @if (item.IsRedeemed)
                                {
                                    <span class="text-amber-600">$0.00</span>
                                }
                                else
                                {
                                    @((item.Price * item.Quantity).ToString("C"))
                                }
                            </span>
                        </div>
                    }
                </div>

                <div class="border-t-2 border-oxford-blue pt-4">
                    <div class="flex justify-between items-center text-xl font-bold text-oxford-blue">
                        <span>Total</span>
                        <span>@totalAmount.ToString("C")</span>
                    </div>
                </div>
            </div>

            <!-- Payment Form -->
            <div class="bg-white rounded-lg shadow-md border border-tan-light p-6">
                <h2 class="text-2xl font-bold text-oxford-blue mb-4">Payment Details</h2>
                
                <!-- Loading indicator - controlled by JavaScript, not Blazor -->
                <div id="payment-loader" class="flex items-center justify-center h-48 bg-gray-50 rounded-lg mb-6">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-oxford-blue"></div>
                </div>
                
                <!-- Stripe Payment Element container - starts hidden -->
                <div id="payment-element" class="mb-6 min-h-[200px]" style="display:none"></div>

                @if (paymentError != null)
                {
                    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
                        @paymentError
                    </div>
                }

                <button id="pay-button" 
                        class="w-full bg-oxford-blue text-white px-6 py-4 rounded-lg font-semibold text-lg hover:-translate-y-0.5 hover:shadow-lg hover:shadow-oxford-blue/40 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                        @onclick="ProcessPayment"
                        disabled>
                    @if (isProcessingPayment)
                    {
                        <span class="inline-block animate-spin mr-2">⏳</span>
                        <span>Processing...</span>
                    }
                    else
                    {
                        <span>Pay @totalAmount.ToString("C")</span>
                    }
                </button>

                <p class="text-center text-gray-500 text-sm mt-4">
                    <i class="bi bi-lock-fill mr-1"></i>
                    Secured by Stripe
                </p>
            </div>
        </div>

        <div class="mt-6 text-center">
            <a href="/cart" class="text-oxford-blue hover:underline">
                <i class="bi bi-arrow-left mr-1"></i>
                Back to Cart
            </a>
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private string loadingMessage = "Preparing checkout...";
    private string? errorMessage;
    private string? paymentError;
    private bool stripeReady = false;
    private bool isProcessingPayment = false;
    private bool paymentSucceeded = false;
    private decimal totalAmount = 0;
    
    private CheckoutSessionResponse? checkoutSession;

    protected override async Task OnInitializedAsync()
    {
        await CartService.InitializeAsync();

        // Validate cart is not empty
        if (!CartService.Items.Any())
        {
            Navigation.NavigateTo("/cart");
            return;
        }

        totalAmount = CartService.TotalAmount;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitiateCheckout();
        }
    }

    private async Task InitiateCheckout()
    {
        try
        {
            isLoading = true;
            loadingMessage = "Creating payment session...";
            StateHasChanged();

            // Build checkout request from cart
            // Note: Loyalty offers will be redeemed in the backend after successful payment
            var paidItems = CartService.Items
                .Where(i => !i.IsRedeemed)
                .Select(i => new CheckoutItemDto(i.MenuItemId, i.Quantity))
                .ToList();

            var redeemedItemIds = CartService.Items
                .Where(i => i.IsRedeemed)
                .Select(i => i.MenuItemId)
                .ToList();
            
            // Get pending offer IDs to send to backend for redemption after payment
            var pendingOfferIds = CartService.GetPendingOfferIds();

            var request = new InitiateCheckoutRequest(
                paidItems,
                redeemedItemIds.Any() ? redeemedItemIds : null,
                pendingOfferIds.Any() ? pendingOfferIds : null
            );

            // 3. Call API to create checkout session
            loadingMessage = "Connecting to payment provider...";
            StateHasChanged();


            var initResult = await PaymentService.InitiateCheckoutAsync(request);

            if (initResult == null)
            {
                errorMessage = "Failed to create checkout session.";
                isLoading = false;
                StateHasChanged();
                return;
            }

            // If server returned FreeCheckoutResponse (order created without payment)
            if (initResult.Free != null)
            {
                // Order created, show success to user
                isLoading = false;
                paymentSucceeded = true;
                await CartService.ClearAsync();
                StateHasChanged();
                // Optionally navigate to orders after a short delay
                await Task.Delay(1500);
                Navigation.NavigateTo($"/orders");
                return;
            }

            checkoutSession = initResult.Session;

            if (checkoutSession == null)
            {
                errorMessage = "Failed to create checkout session.";
                isLoading = false;
                StateHasChanged();
                return;
            }

            isLoading = false;
            StateHasChanged();

            // 4. Initialize Stripe - wait for DOM to be ready
            await Task.Delay(200);
            
            var stripeInitialized = await JS.InvokeAsync<bool>("initializeStripe", checkoutSession.PublishableKey);
            if (!stripeInitialized)
            {
                errorMessage = "Failed to initialize payment system.";
                StateHasChanged();
                return;
            }

            // 5. Mount Payment Element
            var elementMounted = await JS.InvokeAsync<bool>("mountPaymentElement", checkoutSession.ClientSecret, "payment-element");
            Console.WriteLine($"Element mounted result: {elementMounted}");
            
            if (!elementMounted)
            {
                errorMessage = "Failed to load payment form.";
                StateHasChanged();
                return;
            }

            // Show the payment element via JavaScript (no Blazor re-render)
            await JS.InvokeVoidAsync("showPaymentElement");
            
            stripeReady = true;
            Console.WriteLine($"stripeReady set to: {stripeReady}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Checkout error: {ex.Message}";
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ProcessPayment()
    {
        if (!stripeReady || isProcessingPayment)
            return;

        try
        {
            isProcessingPayment = true;
            paymentError = null;
            StateHasChanged();

            var returnUrl = Navigation.ToAbsoluteUri("/checkout").ToString();
            var result = await JS.InvokeAsync<PaymentResult>("confirmStripePayment", returnUrl);

            if (result.Success)
            {
                // Payment succeeded!
                paymentSucceeded = true;
                await CartService.ClearAsync();
                StateHasChanged();

                // Wait a moment then redirect to orders
                await Task.Delay(2000);
                Navigation.NavigateTo("/orders");
            }
            else
            {
                paymentError = result.Error ?? "Payment failed. Please try again.";
            }
        }
        catch (Exception ex)
        {
            paymentError = $"Payment error: {ex.Message}";
        }
        finally
        {
            isProcessingPayment = false;
            StateHasChanged();
        }
    }

    private async Task RetryCheckout()
    {
        errorMessage = null;
        paymentError = null;
        stripeReady = false;
        StateHasChanged();
        
        await InitiateCheckout();
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("destroyStripeElements");
        }
        catch
        {
            // Ignore errors during disposal
        }
    }

    // Helper class for JS interop result
    private class PaymentResult
    {
        public bool Success { get; set; }
        public string? Error { get; set; }
        public string? Status { get; set; }
        public string? PaymentIntentId { get; set; }
    }
}
