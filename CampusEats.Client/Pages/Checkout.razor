@page "/checkout/{orderId:guid}"
@using CampusEats.Client.Services
@using CampusEats.Client.Models
@inject PaymentService PaymentService
@inject OrderService OrderService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject IConfiguration Configuration
@implements IAsyncDisposable

<PageTitle>Checkout - CampusEats</PageTitle>

<div class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold text-oxford-blue mb-8">Secure Checkout</h1>

    @if (_isLoading)
    {
        <div class="bg-white rounded-lg shadow-md border border-tan-light p-12 text-center">
            <div class="inline-block animate-spin text-4xl mb-4">⏳</div>
            <p class="text-gray-600">Loading payment information...</p>
        </div>
    }
    else if (_errorMessage != null)
    {
        <div class="bg-red-50 border-2 border-red-200 rounded-lg p-6">
            <h3 class="text-xl font-bold text-red-700 mb-2">Payment Error</h3>
            <p class="text-red-600 mb-4">@_errorMessage</p>
            <button class="bg-oxford-blue text-white px-6 py-3 rounded-lg font-semibold hover:-translate-y-0.5 hover:shadow-lg transition-all"
                    @onclick="NavigateToOrders">
                Return to Orders
            </button>
        </div>
    }
    else if (_paymentSucceeded)
    {
        <div class="bg-green-50 border-2 border-green-200 rounded-lg p-8 text-center">
            <div class="text-6xl mb-4">✓</div>
            <h3 class="text-2xl font-bold text-green-700 mb-2">Payment Successful!</h3>
            <p class="text-green-600 mb-6">Your order has been confirmed and sent to the kitchen.</p>
            <button class="bg-oxford-blue text-white px-6 py-3 rounded-lg font-semibold hover:-translate-y-0.5 hover:shadow-lg transition-all"
                    @onclick="NavigateToOrders">
                View My Orders
            </button>
        </div>
    }
    else if (_order != null && _payment != null)
    {
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md border border-tan-light p-6 mb-6">
                    <h2 class="text-2xl font-bold text-oxford-blue mb-4">Order Summary</h2>
                    <div class="border-t border-tan-light pt-4">
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-600">Order ID:</span>
                            <span class="font-mono text-sm">@_order.OrderId.ToString()[..8]...</span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-600">Order Date:</span>
                            <span>@_order.OrderDate.ToString("MMM dd, yyyy HH:mm")</span>
                        </div>
                        <div class="flex justify-between items-center pt-4 border-t border-tan-light">
                            <span class="text-xl font-bold text-oxford-blue">Total Amount:</span>
                            <span class="text-2xl font-bold text-oxford-blue">@_order.TotalAmount.ToString("C")</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md border border-tan-light p-6">
                    <h2 class="text-2xl font-bold text-oxford-blue mb-4">Payment Details</h2>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-2">
                            Card Information
                        </label>
                        <div class="border-2 border-tan-light rounded-lg bg-white p-4">
                            <div id="card-element" class="w-full"></div>
                        </div>
                        <div id="card-errors" class="text-red-600 text-sm mt-2 hidden"></div>
                    </div>

                    <button class="w-full bg-oxford-blue text-white px-6 py-4 rounded-lg font-semibold text-lg hover:-translate-y-0.5 hover:shadow-lg hover:shadow-oxford-blue/40 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0"
                            @onclick="ProcessPayment"
                            disabled="@_isProcessing">
                        @if (_isProcessing)
                        {
                            <span class="inline-block animate-spin mr-2">⏳</span>
                            <span>Processing Payment...</span>
                        }
                        else
                        {
                            <span>Pay @_order.TotalAmount.ToString("C")</span>
                        }
                    </button>

                    @if (_paymentError != null)
                    {
                        <div class="bg-red-50 border-2 border-red-200 text-red-700 px-4 py-3 rounded-lg mt-4">
                            <strong>Payment Failed:</strong> @_paymentError
                        </div>
                    }
                </div>
            </div>

            <div class="lg:col-span-1">
                <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 sticky top-4">
                    <h3 class="text-lg font-bold text-oxford-blue mb-4">🔒 Secure Payment</h3>
                    <ul class="space-y-3 text-sm text-gray-700">
                        <li class="flex items-start">
                            <span class="mr-2">✓</span>
                            <span>Your payment is processed securely by Stripe</span>
                        </li>
                        <li class="flex items-start">
                            <span class="mr-2">✓</span>
                            <span>We never store your card details</span>
                        </li>
                        <li class="flex items-start">
                            <span class="mr-2">✓</span>
                            <span>All transactions are encrypted</span>
                        </li>
                        <li class="flex items-start">
                            <span class="mr-2">✓</span>
                            <span>PCI DSS compliant</span>
                        </li>
                    </ul>
                    
                    <div class="mt-6 pt-6 border-t border-blue-300">
                        <p class="text-xs text-gray-600 text-center">
                            Powered by <strong>Stripe</strong>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public Guid OrderId { get; set; }

    private OrderResponse? _order;
    private Models.PaymentResponse? _payment;
    private bool _isLoading = true;
    private bool _isProcessing;
    private bool _paymentSucceeded;
    private string? _errorMessage;
    private string? _paymentError;

    private bool _stripeInitialized = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Load order details
            _order = await OrderService.GetOrderByIdAsync(OrderId);
            
            if (_order == null)
            {
                _errorMessage = "Order not found.";
                _isLoading = false;
                return;
            }

            // Only allow payment for Pending orders
            if (_order.Status != "Pending")
            {
                _errorMessage = $"This order cannot be paid. Current status: {_order.Status}";
                _isLoading = false;
                return;
            }

            // Create payment and get ClientSecret
            _payment = await PaymentService.CreatePaymentAsync(OrderId);
            
            if (_payment == null || string.IsNullOrEmpty(_payment.ClientSecret))
            {
                _errorMessage = "Failed to initialize payment. Please try again.";
                _isLoading = false;
                return;
            }

            // Loading finished, data is ready
            _isLoading = false;
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            Navigation.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
            _isLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Această condiție verifică doar dacă avem datele necesare și nu am inițializat deja Stripe.
        // Rulează la fiecare render, dar intră în if doar când trebuie.
        if (!_stripeInitialized && _payment != null && !string.IsNullOrEmpty(_payment.ClientSecret))
        {
            await InitializeStripe();
        }
    }

    private async Task InitializeStripe()
    {
        if (_payment == null || string.IsNullOrEmpty(_payment.ClientSecret))
        {
            return;
        }

        try
        {
            await Task.Delay(100);
            
            var stripePublishableKey = Configuration["Stripe:PublishableKey"];
            
            if (string.IsNullOrEmpty(stripePublishableKey))
            {
                _errorMessage = "Stripe configuration is missing. Please contact support.";
                StateHasChanged();
                return;
            }

            _stripeInitialized = true;

            Console.WriteLine($"Initializing Stripe...");
            
            var initialized = await JS.InvokeAsync<bool>("stripeHelper.initialize", stripePublishableKey);
            
            if (!initialized)
            {
                _errorMessage = "Failed to initialize payment system.";
                _stripeInitialized = false; // Resetăm dacă a eșuat
                StateHasChanged();
                return;
            }

            Console.WriteLine("Stripe initialized, mounting card element...");
            
            // Mount the card element
            var mounted = await JS.InvokeAsync<bool>("stripeHelper.mountCardElement", "card-element");
            
            if (!mounted)
            {
                _errorMessage = "Failed to load payment form.";
                StateHasChanged();
                return;
            }

            Console.WriteLine("Card element mounted successfully");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Payment system error: {ex.Message}");
            _errorMessage = $"Payment system error: {ex.Message}";
            _stripeInitialized = false;
            StateHasChanged();
        }
    }

    private async Task ProcessPayment()
    {
        if (_payment == null || string.IsNullOrEmpty(_payment.ClientSecret))
        {
            _paymentError = "Payment information is missing.";
            return;
        }

        try
        {
            _isProcessing = true;
            _paymentError = null;
            StateHasChanged();

            // Call Stripe.js to confirm the payment
            var result = await JS.InvokeAsync<PaymentResult>("stripeHelper.confirmCardPayment", _payment.ClientSecret);

            if (result.Success)
            {
                _paymentSucceeded = true;
                
                // Wait a moment then redirect to orders
                await Task.Delay(2000);
                Navigation.NavigateTo("/orders");
            }
            else
            {
                _paymentError = result.Error ?? "Payment failed. Please try again.";
            }
        }
        catch (Exception ex)
        {
            _paymentError = $"An unexpected error occurred: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
            StateHasChanged();
        }
    }

    private void NavigateToOrders()
    {
        Navigation.NavigateTo("/orders");
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("stripeHelper.destroy");
        }
        catch
        {
            // Ignore errors during cleanup
        }
    }

    private class PaymentResult
    {
        public bool Success { get; set; }
        public string? Error { get; set; }
        public string? PaymentIntentId { get; set; }
    }
}