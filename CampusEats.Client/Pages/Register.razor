@page "/register"
@using CampusEats.Client.Models
@using CampusEats.Client.Services
@inject AuthService AuthService
@inject NavigationManager Navigation
@layout AuthLayout

<PageTitle>Register - CampusEats</PageTitle>

<div class="flex min-h-screen w-full font-sans">
    <div class="flex flex-1 items-center justify-center p-8 bg-tan-light">
        <div class="w-full max-w-md">
            <div class="text-center mb-10">
                <img src="/images/logo.svg" alt="CampusEats Logo" class="w-50 mx-auto mb-6" />
                <p class="text-gray-600 text-lg leading-relaxed">Create your account to get started</p>
            </div>

            @if (errorMessage != null)
            {
                <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
                    @errorMessage
                </div>
            }

            <form @onsubmit="HandleRegister" class="space-y-6">
                <div>
                    <label for="fullname" class="block mb-2 text-oxford-blue font-semibold text-base tracking-wide">Full Name</label>
                    <input type="text"
                           id="fullname"
                           class="w-full px-4 py-3 text-base border-2 border-tan-light rounded-lg focus:border-oxford-blue focus:outline-none focus:ring-2 focus:ring-oxford-blue/15 transition-all"
                           @bind="registerRequest.Name"
                           placeholder="John Doe"
                           required />
                </div>

                <div>
                    <label for="email" class="block mb-2 text-oxford-blue font-semibold text-base tracking-wide">Email Address</label>
                    <input type="email"
                           id="email"
                           class="w-full px-4 py-3 text-base border-2 border-tan-light rounded-lg focus:border-oxford-blue focus:outline-none focus:ring-2 focus:ring-oxford-blue/15 transition-all"
                           @bind="registerRequest.Email"
                           placeholder="your@email.com"
                           required />
                </div>

                <div>
                    <label for="password" class="block mb-2 text-oxford-blue font-semibold text-base tracking-wide">Password</label>
                    <input type="password"
                           id="password"
                           class="w-full px-4 py-3 text-base border-2 border-tan-light rounded-lg focus:border-oxford-blue focus:outline-none focus:ring-2 focus:ring-oxford-blue/15 transition-all"
                           @bind="registerRequest.Password"
                           placeholder="Enter a strong password"
                           required />
                </div>

                <div>
                    <label for="confirmPassword" class="block mb-2 text-oxford-blue font-semibold text-base tracking-wide">Confirm Password</label>
                    <input type="password"
                           id="confirmPassword"
                           class="w-full px-4 py-3 text-base border-2 border-tan-light rounded-lg focus:border-oxford-blue focus:outline-none focus:ring-2 focus:ring-oxford-blue/15 transition-all"
                           @bind="registerRequest.ConfirmPassword"
                           placeholder="Re-enter your password"
                           required />
                </div>

                <button type="submit"
                        class="w-full bg-oxford-blue text-white px-6 py-3 text-base font-semibold rounded-lg hover:-translate-y-0.5 hover:shadow-lg hover:shadow-oxford-blue/40 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span class="inline-block animate-spin mr-2">‚è≥</span>
                        <span>Creating account...</span>
                    }
                    else
                    {
                        <span>Create Account</span>
                    }
                </button>
            </form>

            <div class="relative text-center my-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-tan"></div>
                </div>
                <span class="relative bg-tan-light px-4 text-gray-600 text-sm">Already have an account?</span>
            </div>

            <button class="w-full bg-tan text-oxford-blue px-6 py-3 text-base font-semibold rounded-lg hover:bg-tan-dark hover:text-white hover:-translate-y-0.5 hover:shadow-lg hover:shadow-tan/40 transition-all"
                    @onclick="GoToLogin">
                Sign In
            </button>
        </div>
    </div>

    <div class="flex-1 flex items-center justify-center bg-gradient-to-br from-oxford-blue to-oxford-blue-dark p-12">
        <img src="/images/shaorma-boss.svg"
             alt="CampusEats"
             class="max-w-2xl w-full h-auto drop-shadow-2xl animate-float" />
    </div>
</div>

@code {
    private readonly RegisterRequest registerRequest = new();
    private bool isLoading = false;
    private string? errorMessage;

    private async Task HandleRegister()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            // Validate passwords match
            if (registerRequest.Password != registerRequest.ConfirmPassword)
            {
                errorMessage = "Passwords do not match.";
                isLoading = false;
                return;
            }

            // Validate password strength (API requires minimum 8 characters)
            if (registerRequest.Password.Length < 8)
            {
                errorMessage = "Password must be at least 8 characters long.";
                isLoading = false;
                return;
            }

            var result = await AuthService.RegisterAsync(registerRequest);

            if (result != null)
            {
                Navigation.NavigateTo("/menu");
            }
            else
            {
                errorMessage = "Registration failed. Email might already be in use.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoToLogin()
    {
        Navigation.NavigateTo("/login");
    }
}