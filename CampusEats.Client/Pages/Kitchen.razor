@page "/kitchen"
@using CampusEats.Client.Models
@using CampusEats.Client.Services
@using CampusEats.Client.Components.Common
@using CampusEats.Client.Components.Kitchen
@using Blazored.LocalStorage
@inject KitchenService KitchenService
@inject AuthService AuthService
@inject OrderHubService OrderHubService
@inject ILocalStorageService LocalStorage
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>Kitchen - CampusEats</PageTitle>

<!-- Hidden audio element for new order notification sound -->
<audio id="newOrderSound" preload="auto">
    <source src="/sounds/notification.mp3" type="audio/mpeg" />
</audio>

<div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center gap-3 mb-2">
                <div class="p-2 bg-oxford-blue rounded-xl">
                    <svg class="w-8 h-8 text-tan" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-slate-800">Kitchen Dashboard</h1>
                    <p class="text-slate-500">Manage and track incoming orders</p>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        @if (!isLoading && error == null)
        {
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <StatCard Value="@GetStatusCount("Pending").ToString()" Label="Pending" IconBgClass="bg-amber-100">
                    <IconContent>
                        <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </IconContent>
                </StatCard>
                <StatCard Value="@GetStatusCount("InPreparation").ToString()" Label="Preparing" IconBgClass="bg-blue-100">
                    <IconContent>
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </IconContent>
                </StatCard>
                <StatCard Value="@GetStatusCount("Ready").ToString()" Label="Ready" IconBgClass="bg-emerald-100">
                    <IconContent>
                        <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </IconContent>
                </StatCard>
                <StatCard Value="@GetStatusCount("Completed").ToString()" Label="Completed" IconBgClass="bg-slate-100">
                    <IconContent>
                        <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </IconContent>
                </StatCard>
            </div>
        }

        <!-- Section Tabs & Filters -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-4 gap-4">
                <div class="flex gap-2">
                    <button class="@(activeSection == "orders" ? "bg-oxford-blue text-white shadow-md" : "bg-slate-100 text-slate-600 hover:bg-slate-200") px-5 py-2.5 rounded-lg font-medium transition-all duration-200"
                            @onclick="SetOrdersSection">
                        <span class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            Orders
                        </span>
                    </button>
                    <button class="@(activeSection == "analytics" ? "bg-oxford-blue text-white shadow-md" : "bg-slate-100 text-slate-600 hover:bg-slate-200") px-5 py-2.5 rounded-lg font-medium transition-all duration-200"
                            @onclick="SetAnalyticsSection">
                        <span class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            Analytics
                        </span>
                    </button>
                </div>

                @if (activeSection == "orders")
                {
                    <label class="flex items-center gap-2 cursor-pointer select-none">
                        <div class="relative">
                            <input type="checkbox"
                                   class="sr-only peer"
                                   @bind="showCompleted"
                                   @bind:after="LoadOrders" />
                            <div class="w-10 h-6 bg-slate-200 rounded-full peer peer-checked:bg-oxford-blue transition-colors"></div>
                            <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-4 shadow-sm"></div>
                        </div>
                        <span class="text-sm text-slate-600">Show completed</span>
                    </label>
                }
            </div>
        </div>

        @if (activeSection == "orders")
        {
            @if (isLoading)
            {
                <LoadingSpinner Message="Loading orders..." />
            }
            else if (error != null)
            {
                <ErrorAlert Title="Error loading orders" Message="@error" />
            }
            else if (!filteredOrders.Any())
            {
                <EmptyState Title="No orders to display"
                            Description="@(showCompleted ? "There are no orders in the system." : "All caught up! No active orders at the moment.")" />
            }
            else
            {
                <div class="grid gap-4">
                    @foreach (var order in filteredOrders)
                    {
                        <KitchenOrderCard Order="@order"
                                          IsProcessing="@(processingOrderId == order.Id)"
                                          OnPrepare="PrepareOrder"
                                          OnReady="ReadyOrder"
                                          OnComplete="CompleteOrder" />
                    }
                </div>
            }
        }
        else if (activeSection == "analytics")
        {
            <AnalyticsDateControls QuickPeriod="@quickPeriod"
                                   ViewMode="@analyticsViewMode"
                                   PeriodDisplayText="@GetPeriodDisplayText()"
                                   OnQuickPeriodChange="SetQuickPeriod"
                                   OnViewModeChange="SetViewMode"
                                   OnPrevious="PreviousPeriod"
                                   OnNext="NextPeriod" />

            @if (analyticsLoading)
            {
                <LoadingSpinner Message="Loading analytics..." />
            }
            else if (analyticsError != null)
            {
                <ErrorAlert Title="Error loading analytics" Message="@analyticsError" />
            }
            else if (analytics != null)
            {
                <AnalyticsSummaryRow Summary="@analytics.Summary" />

                <!-- Main Chart -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Orders & Revenue Over Time</h3>
                    <div id="mainChart" style="height: 350px;"></div>
                </div>

                <AnalyticsPerformanceRow Performance="@analytics.Performance" />
                <AnalyticsItemInsights Items="@analytics.Items" />
                <AnalyticsRevenueInsights Revenue="@analytics.Revenue" />
                <AnalyticsCustomerInsights Customers="@analytics.Customers" />
            }
        }
    </div>
</div>

@code {
    private string activeSection = "orders";
    private List<KitchenOrderResponse> orders = new();
    private bool showCompleted = false;
    private bool isLoading = true;
    private string? error;
    private Guid? processingOrderId;

    private IEnumerable<KitchenOrderResponse> filteredOrders =>
        orders
            .Where(o => showCompleted || o.Status != "Completed")
            .OrderByDescending(o => o.CreatedAt);

    // Analytics State
    private AnalyticsResponse? analytics;
    private bool analyticsLoading = false;
    private string? analyticsError;
    private string analyticsViewMode = "day";
    private DateTime analyticsStartDate = DateTime.Today;
    private DateTime analyticsEndDate = DateTime.Today.AddDays(1);
    private string quickPeriod = "today";
    private bool shouldRenderCharts = false;

    protected override async Task OnInitializedAsync()
    {
        var role = await AuthService.GetUserRoleAsync();
        if (role != "Admin" && role != "Manager")
        {
            Navigation.NavigateTo("/menu");
            return;
        }

        OrderHubService.OnNewOrder += HandleNewOrder;
        OrderHubService.OnOrderCancelled += HandleOrderCancelled;
        OrderHubService.OnOrderStatusChanged += HandleOrderStatusChanged;
        OrderHubService.OnReconnected += HandleReconnected;

        try
        {
            await OrderHubService.StartAsync(
                async () => await LocalStorage.GetItemAsync<string>("authToken"));
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SignalR connection failed: {ex.Message}");
        }

        await LoadOrders();
    }

    private async void HandleNewOrder(NewOrderNotification notification)
    {
        try
        {
            var newOrder = new KitchenOrderResponse(
                notification.OrderId,
                notification.Status,
                notification.OrderDate,
                notification.Items.Select(i => new KitchenOrderItemResponse(i.MenuItemId, i.Name, i.Quantity, i.UnitPrice)).ToList()
            );

            orders.Insert(0, newOrder);
            await InvokeAsync(StateHasChanged);

            try
            {
                await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('newOrderSound').play().catch(() => {})");
            }
            catch { }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error handling new order: {ex.Message}");
        }
    }

    private async void HandleOrderCancelled(Guid orderId)
    {
        try
        {
            var order = orders.FirstOrDefault(o => o.Id == orderId);
            if (order != null)
            {
                orders.Remove(order);
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error handling order cancellation: {ex.Message}");
        }
    }

    private async void HandleOrderStatusChanged(OrderStatusUpdate update)
    {
        try
        {
            var index = orders.FindIndex(o => o.Id == update.OrderId);
            if (index >= 0)
            {
                var existing = orders[index];
                orders[index] = existing with { Status = update.Status };
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error handling order status change: {ex.Message}");
        }
    }

    private async void HandleReconnected()
    {
        try
        {
            await InvokeAsync(async () => await LoadOrders());
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error refreshing orders after reconnection: {ex.Message}");
        }
    }

    private async Task LoadOrders()
    {
        try
        {
            isLoading = true;
            error = null;
            orders = await KitchenService.GetKitchenOrdersAsync();
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            Navigation.NavigateTo("/login");
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Forbidden)
        {
            Navigation.NavigateTo("/menu");
        }
        catch (Exception ex)
        {
            error = $"Failed to load orders: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task PrepareOrder(Guid orderId) => await UpdateOrderStatus(orderId, () => KitchenService.PrepareOrderAsync(orderId));
    private async Task ReadyOrder(Guid orderId) => await UpdateOrderStatus(orderId, () => KitchenService.ReadyOrderAsync(orderId));
    private async Task CompleteOrder(Guid orderId) => await UpdateOrderStatus(orderId, () => KitchenService.CompleteOrderAsync(orderId));

    private async Task UpdateOrderStatus(Guid orderId, Func<Task> action)
    {
        try
        {
            processingOrderId = orderId;
            await action();
            await LoadOrders();
        }
        catch (Exception ex)
        {
            error = $"Failed to update order: {ex.Message}";
        }
        finally
        {
            processingOrderId = null;
        }
    }

    private int GetStatusCount(string status) => orders.Count(o => o.Status == status);
    private void SetOrdersSection() => activeSection = "orders";

    private async Task SetAnalyticsSection()
    {
        activeSection = "analytics";
        if (analytics == null)
            await LoadAnalytics();
    }

    private async Task LoadAnalytics()
    {
        try
        {
            analyticsLoading = true;
            analyticsError = null;
            shouldRenderCharts = false;
            StateHasChanged();

            var groupBy = analyticsViewMode switch
            {
                "day" => "hour",
                "week" => "day",
                "month" => "day",
                "year" => "month",
                _ => "hour"
            };

            analytics = await KitchenService.GetAnalyticsAsync(analyticsStartDate, analyticsEndDate, groupBy);
            shouldRenderCharts = true;
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            Navigation.NavigateTo("/login");
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Forbidden)
        {
            Navigation.NavigateTo("/menu");
        }
        catch (Exception ex)
        {
            analyticsError = $"Failed to load analytics: {ex.Message}";
        }
        finally
        {
            analyticsLoading = false;
            StateHasChanged();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (shouldRenderCharts && analytics != null)
        {
            shouldRenderCharts = false;
            await RenderCharts();
        }
    }

    private async Task RenderCharts()
    {
        if (analytics == null) return;

        try
        {
            var categories = analytics.TimeSeries.Select(t => FormatTimeSeriesLabel(t.Period)).ToArray();
            var orderData = analytics.TimeSeries.Select(t => t.OrderCount).ToArray();
            var revenueData = analytics.TimeSeries.Select(t => (double)t.Revenue).ToArray();

            await JSRuntime.InvokeVoidAsync("apexChartsInterop.renderRevenueChart", "mainChart", categories, orderData, revenueData);

            var sparklineData = analytics.Revenue.RevenueByHour.Select(r => (double)r.Revenue).ToArray();
            await JSRuntime.InvokeVoidAsync("apexChartsInterop.renderSparkline", "revenueSparkline", sparklineData, "#10b981");

            if (analytics.Revenue.CategoryBreakdown.Any())
            {
                var categoryLabels = analytics.Revenue.CategoryBreakdown.Select(c => c.CategoryName).ToArray();
                var categoryData = analytics.Revenue.CategoryBreakdown.Select(c => (double)c.Revenue).ToArray();
                await JSRuntime.InvokeVoidAsync("apexChartsInterop.renderDonutChart", "categoryDonut", categoryLabels, categoryData, (string[]?)null);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Chart render error: {ex.Message}");
        }
    }

    private string FormatTimeSeriesLabel(DateTime period) => analyticsViewMode switch
    {
        "day" => period.ToString("HH:00"),
        "week" => period.ToString("ddd"),
        "month" => period.ToString("MMM d"),
        "year" => period.ToString("MMM"),
        _ => period.ToString("HH:00")
    };

    private async Task SetQuickPeriod(string period)
    {
        quickPeriod = period;
        var today = DateTime.Today;

        (analyticsViewMode, analyticsStartDate, analyticsEndDate) = period switch
        {
            "today" => ("day", today, today.AddDays(1)),
            "week" => ("week", GetStartOfWeek(today), GetStartOfWeek(today).AddDays(7)),
            "month" => ("month", new DateTime(today.Year, today.Month, 1), new DateTime(today.Year, today.Month, 1).AddMonths(1)),
            "year" => ("year", new DateTime(today.Year, 1, 1), new DateTime(today.Year + 1, 1, 1)),
            _ => (analyticsViewMode, analyticsStartDate, analyticsEndDate)
        };

        await LoadAnalytics();
    }

    private async Task SetViewMode(string mode)
    {
        analyticsViewMode = mode;
        quickPeriod = "";
        var today = DateTime.Today;

        (analyticsStartDate, analyticsEndDate) = mode switch
        {
            "day" => (today, today.AddDays(1)),
            "week" => (GetStartOfWeek(today), GetStartOfWeek(today).AddDays(7)),
            "month" => (new DateTime(today.Year, today.Month, 1), new DateTime(today.Year, today.Month, 1).AddMonths(1)),
            "year" => (new DateTime(today.Year, 1, 1), new DateTime(today.Year + 1, 1, 1)),
            _ => (analyticsStartDate, analyticsEndDate)
        };

        await LoadAnalytics();
    }

    private static DateTime GetStartOfWeek(DateTime date)
    {
        var startOfWeek = date.AddDays(-(int)date.DayOfWeek + (int)DayOfWeek.Monday);
        if (date.DayOfWeek == DayOfWeek.Sunday) startOfWeek = startOfWeek.AddDays(-7);
        return startOfWeek;
    }

    private async Task PreviousPeriod()
    {
        quickPeriod = "";
        (analyticsStartDate, analyticsEndDate) = analyticsViewMode switch
        {
            "day" => (analyticsStartDate.AddDays(-1), analyticsEndDate.AddDays(-1)),
            "week" => (analyticsStartDate.AddDays(-7), analyticsEndDate.AddDays(-7)),
            "month" => (analyticsStartDate.AddMonths(-1), analyticsEndDate.AddMonths(-1)),
            "year" => (analyticsStartDate.AddYears(-1), analyticsEndDate.AddYears(-1)),
            _ => (analyticsStartDate, analyticsEndDate)
        };
        await LoadAnalytics();
    }

    private async Task NextPeriod()
    {
        quickPeriod = "";
        (analyticsStartDate, analyticsEndDate) = analyticsViewMode switch
        {
            "day" => (analyticsStartDate.AddDays(1), analyticsEndDate.AddDays(1)),
            "week" => (analyticsStartDate.AddDays(7), analyticsEndDate.AddDays(7)),
            "month" => (analyticsStartDate.AddMonths(1), analyticsEndDate.AddMonths(1)),
            "year" => (analyticsStartDate.AddYears(1), analyticsEndDate.AddYears(1)),
            _ => (analyticsStartDate, analyticsEndDate)
        };
        await LoadAnalytics();
    }

    private string GetPeriodDisplayText() => analyticsViewMode switch
    {
        "day" => analyticsStartDate.ToString("MMMM d, yyyy"),
        "week" => $"{analyticsStartDate:MMM d} - {analyticsEndDate.AddDays(-1):MMM d, yyyy}",
        "month" => analyticsStartDate.ToString("MMMM yyyy"),
        "year" => analyticsStartDate.ToString("yyyy"),
        _ => analyticsStartDate.ToString("MMMM d, yyyy")
    };

    public async ValueTask DisposeAsync()
    {
        OrderHubService.OnNewOrder -= HandleNewOrder;
        OrderHubService.OnOrderCancelled -= HandleOrderCancelled;
        OrderHubService.OnOrderStatusChanged -= HandleOrderStatusChanged;
        OrderHubService.OnReconnected -= HandleReconnected;

        try
        {
            await JSRuntime.InvokeVoidAsync("apexChartsInterop.destroyChart", "mainChart");
            await JSRuntime.InvokeVoidAsync("apexChartsInterop.destroyChart", "revenueSparkline");
            await JSRuntime.InvokeVoidAsync("apexChartsInterop.destroyChart", "categoryDonut");
        }
        catch { }
    }
}