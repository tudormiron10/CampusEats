@page "/orders"
@using CampusEats.Client.Models
@using CampusEats.Client.Services
@inject OrderService OrderService
@inject NavigationManager Navigation

<PageTitle>My Orders - CampusEats</PageTitle>

<div class="max-w-7xl mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold text-oxford-blue mb-8">My Orders</h1>

    @if (isLoading)
    {
        <div class="text-center py-12">
            <svg class="animate-spin h-16 w-16 mx-auto mb-4 text-oxford-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-600 text-lg">Loading orders...</p>
        </div>
    }
    else if (error != null)
    {
        <div class="bg-red-50 border-2 border-red-200 text-red-700 px-6 py-4 rounded-lg mb-6">
            <strong class="font-semibold">Error:</strong> @error
        </div>
    }
    else if (!orders.Any())
    {
        <div class="bg-blue-50 border-2 border-blue-200 text-blue-700 px-6 py-4 rounded-lg">
            <p class="mb-4">You haven't placed any orders yet.</p>
            <a href="/menu" class="inline-block bg-oxford-blue text-white px-6 py-3 rounded-lg font-semibold hover:-translate-y-0.5 hover:shadow-lg hover:shadow-oxford-blue/40 transition-all">
                Browse Menu
            </a>
        </div>
    }
    else
    {
        <div class="space-y-4">
            @foreach (var order in orders.OrderByDescending(o => o.OrderDate))
            {
                <div class="bg-white rounded-lg shadow-md border border-tan-light overflow-hidden">
                    <div class="bg-tan-light px-6 py-4 cursor-pointer hover:bg-tan transition-colors" @onclick="() => ToggleOrderDetails(order.OrderId)">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-center">
                            <div>
                                <span class="font-bold text-oxford-blue">Order #@GetOrderNumber(order.OrderId)</span>
                            </div>
                            <div class="text-gray-700">
                                @order.OrderDate.ToString("dd/MM/yyyy HH:mm")
                            </div>
                            <div>
                                <span class="@GetStatusBadgeClass(order.Status) px-3 py-1 rounded-full text-sm font-semibold">
                                    @FormatStatus(order.Status)
                                </span>
                            </div>
                            <div class="text-right">
                                <span class="text-2xl font-bold text-oxford-blue">@order.TotalAmount.ToString("C")</span>
                            </div>
                            <div class="text-right text-oxford-blue text-xl">
                                @if (expandedOrders.Contains(order.OrderId))
                                {
                                    <span>▲</span>
                                }
                                else
                                {
                                    <span>▼</span>
                                }
                            </div>
                        </div>
                    </div>
                    @if (expandedOrders.Contains(order.OrderId))
                    {
                        <div class="px-6 py-4 bg-white border-t-2 border-tan-light">
                            @if (orderDetails.ContainsKey(order.OrderId) && orderDetails[order.OrderId] != null)
                            {
                                var details = orderDetails[order.OrderId];
                                <h6 class="font-bold text-oxford-blue mb-3">Items:</h6>
                                <ul class="space-y-2">
                                    @foreach (var item in details!.Items)
                                    {
                                        <li class="flex justify-between items-center text-gray-700">
                                            <span>• @item.Name x @item.Quantity</span>
                                            <span class="font-semibold">@item.UnitPrice.ToString("C")</span>
                                        </li>
                                    }
                                </ul>
                            }
                            else
                            {
                                <div class="text-center py-4">
                                    <div class="inline-block animate-spin text-3xl mb-2">⏳</div>
                                    <p class="text-gray-600">Loading items...</p>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    private List<SimpleOrderResponse> orders = new();
    private Dictionary<Guid, OrderResponse?> orderDetails = new();
    private HashSet<Guid> expandedOrders = new();
    private bool isLoading = true;
    private string? error;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        try
        {
            isLoading = true;
            error = null;

            // Backend returns user's orders based on JWT (or all for staff)
            orders = await OrderService.GetOrdersAsync();
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            Navigation.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            error = $"Failed to load orders: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ToggleOrderDetails(Guid orderId)
    {
        if (expandedOrders.Contains(orderId))
        {
            expandedOrders.Remove(orderId);
        }
        else
        {
            expandedOrders.Add(orderId);

            // Load details if not already loaded
            if (!orderDetails.ContainsKey(orderId))
            {
                try
                {
                    var details = await OrderService.GetOrderByIdAsync(orderId);
                    orderDetails[orderId] = details;
                }
                catch (Exception ex)
                {
                    // Handle error silently or show message
                    Console.WriteLine($"Failed to load order details: {ex.Message}");
                }
            }
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pending" => "bg-yellow-100 text-yellow-800",
            "InPreparation" => "bg-blue-100 text-blue-800",
            "Ready" => "bg-green-100 text-green-800",
            "Completed" => "bg-gray-100 text-gray-800",
            "Cancelled" => "bg-red-100 text-red-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }

    private string GetOrderNumber(Guid orderId)
    {
        // Convert GUID to a short, friendly order number (6 digits)
        return Math.Abs(orderId.GetHashCode() % 1000000).ToString("D6");
    }

    private string FormatStatus(string status)
    {
        // Add spaces before capital letters for better readability
        return System.Text.RegularExpressions.Regex.Replace(status, "([a-z])([A-Z])", "$1 $2");
    }
}